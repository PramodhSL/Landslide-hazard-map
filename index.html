<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Landslide Hazard Zonation Map</title>
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #0f172a;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
            touch-action: none;
            /* Improves touch handling on mobile */
        }

        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(15px);
            padding: 2.5rem 3.5rem;
            border-radius: 20px;
            border: 2px solid rgba(139, 92, 246, 0.4);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.7);
            text-align: center;
            z-index: 10000;
            display: none;
        }

        #loading-indicator.active {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 1.5rem;
            border: 5px solid rgba(139, 92, 246, 0.2);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #loading-indicator p {
            color: #e2e8f0;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        #loading-indicator small {
            color: #94a3b8;
            font-size: 0.85rem;
        }

        /* Search Box */
        .search-container {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1000;
            width: 320px;
            max-width: calc(100vw - 2rem);
        }

        .search-box {
            position: relative;
            background: rgba(15, 23, 42, 0.97);
            backdrop-filter: blur(12px);
            border-radius: 14px;
            border: 1px solid rgba(139, 92, 246, 0.35);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .search-input-wrapper {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            gap: 0.75rem;
        }

        .search-icon {
            color: #8b5cf6;
            font-size: 1.2rem;
        }

        #search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #e2e8f0;
            font-size: 0.95rem;
            outline: none;
        }

        #search-input::placeholder {
            color: #64748b;
        }

        #clear-search {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0.25rem;
            display: none;
        }

        #clear-search:hover {
            color: #e2e8f0;
        }

        #search-results {
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            display: none;
        }

        .search-result-item {
            padding: 0.875rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .result-title {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .result-subtitle {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .no-results {
            padding: 1.5rem 1rem;
            text-align: center;
            color: #64748b;
            font-size: 0.9rem;
        }

        .controls-panel {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(15, 23, 42, 0.97);
            backdrop-filter: blur(12px);
            border-radius: 18px;
            padding: 1.5rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(139, 92, 246, 0.35);
            z-index: 1000;
            min-width: 280px;
            max-width: 90vw;
        }

        .controls-panel h3 {
            color: #e2e8f0;
            font-size: 1.15rem;
            margin: 0;
            font-weight: 700;
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            cursor: pointer;
            user-select: none;
        }

        .controls-panel.collapsed .controls-header {
            margin-bottom: 0;
        }

        .controls-toggle-btn {
            background: none;
            border: none;
            color: #8b5cf6;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: transform 0.3s ease;
        }

        .controls-panel.collapsed .controls-toggle-btn {
            transform: rotate(180deg);
        }

        .controls-content {
            transition: all 0.3s ease;
        }

        .controls-panel.collapsed .controls-content {
            display: none;
        }

        .controls-panel.collapsed {
            padding: 1rem 1.5rem;
        }

        .layer-section h4 {
            color: #cbd5e1;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .layer-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.85rem;
        }

        .layer-label {
            color: #cbd5e1;
            font-size: 0.95rem;
            font-weight: 500;
            flex: 1;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #334155;
            transition: 0.3s ease;
            border-radius: 28px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background: linear-gradient(135deg, #64748b, #475569);
            transition: 0.3s ease;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        input:checked+.slider {
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .action-btn {
            width: 100%;
            padding: 0.85rem 1.25rem;
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(139, 92, 246, 0.5);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .legend {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem 1.25rem;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            line-height: 26px;
            color: #cbd5e1;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .legend.collapsed {
            padding: 0;
            overflow: hidden;
        }

        .legend.collapsed .legend-content {
            display: none;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            cursor: pointer;
            user-select: none;
        }

        .legend.collapsed .legend-header {
            margin-bottom: 0;
            padding: 0.75rem 1rem;
        }

        .legend h4 {
            margin: 0;
            color: #e2e8f0;
            font-size: 1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .legend-toggle {
            background: none;
            border: none;
            color: #8b5cf6;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: transform 0.3s ease;
        }

        .legend.collapsed .legend-toggle {
            transform: rotate(180deg);
        }

        .legend-content {
            transition: all 0.3s ease;
        }

        .legend i {
            width: 20px;
            height: 20px;
            float: left;
            margin-right: 10px;
            opacity: 0.85;
            border-radius: 3px;
        }

        .maplibregl-ctrl-group {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .maplibregl-ctrl-group button {
            background: transparent;
            color: #cbd5e1;
        }

        .maplibregl-ctrl-group button:hover {
            background: rgba(139, 92, 246, 0.3);
        }

        .maplibregl-popup-content {
            background: rgba(15, 23, 42, 0.97);
            color: #e2e8f0;
            border-radius: 14px;
            border: 1px solid rgba(139, 92, 246, 0.35);
            padding: 1.25rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .maplibregl-popup-tip {
            border-top-color: rgba(15, 23, 42, 0.97);
        }

        .popup-title {
            font-weight: 700;
            font-size: 1.05rem;
            color: #8b5cf6;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        }

        .popup-info {
            color: #cbd5e1;
        }

        .popup-info b {
            color: #06b6d4;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .search-container {
                width: calc(100vw - 2rem);
                top: 0.5rem;
                left: 0.5rem;
            }

            .search-box {
                border-radius: 12px;
            }

            .search-input-wrapper {
                padding: 0.65rem 0.85rem;
            }

            #search-input {
                font-size: 0.9rem;
            }

            #search-results {
                max-height: 200px;
            }

            .search-result-item {
                padding: 0.75rem 0.85rem;
            }

            .result-title {
                font-size: 0.85rem;
            }

            .result-subtitle {
                font-size: 0.75rem;
            }

            .controls-panel {
                top: auto;
                bottom: 0;
                right: 0;
                left: 0;
                max-width: none;
                padding: 1rem;
                border-radius: 18px 18px 0 0;
                border-bottom: none;
                max-height: 50vh;
                overflow-y: auto;
            }

            .controls-panel h3 {
                font-size: 1rem;
                margin: 0;
            }

            .controls-header {
                margin-bottom: 1rem;
            }

            .controls-panel.collapsed .controls-header {
                margin-bottom: 0;
            }

            .layer-section h4 {
                font-size: 0.85rem;
                margin-bottom: 0.6rem;
            }

            .layer-toggle {
                margin-bottom: 0.85rem;
            }

            .layer-label {
                font-size: 0.9rem;
            }

            .action-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                margin-top: 1rem;
            }

            .legend {
                bottom: auto;
                top: 4.5rem;
                right: 0.5rem;
                left: auto;
                font-size: 0.75rem;
                padding: 0.75rem 0.9rem;
                line-height: 22px;
                max-width: calc(100vw - 1rem);
            }

            .legend h4 {
                font-size: 0.9rem;
                margin-bottom: 0.6rem;
            }

            .legend i {
                width: 14px;
                height: 14px;
                margin-right: 8px;
            }

            .legend br {
                line-height: 20px;
            }

            .maplibregl-ctrl-bottom-left {
                bottom: 52vh;
            }
        }

        @media (max-width: 480px) {
            .search-container {
                top: 0.5rem;
                left: 0.5rem;
                right: 0.5rem;
                width: auto;
            }

            .controls-panel {
                padding: 0.85rem;
            }

            .legend {
                top: 4rem;
                right: 0.5rem;
                padding: 0.65rem 0.75rem;
                font-size: 0.7rem;
                line-height: 20px;
            }

            .legend h4 {
                font-size: 0.85rem;
            }

            .legend i {
                width: 12px;
                height: 12px;
                margin-right: 6px;
            }
        }
    </style>
</head>

<body>
    <div id="loading-indicator" class="active">
        <div class="spinner"></div>
        <p>Loading Maps...</p>
        <small>This may take a moment</small>
    </div>

    <div id="map"></div>

    <!-- Search Box -->
    <div class="search-container">
        <div class="search-box">
            <div class="search-input-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="search-input" placeholder="Search location in Sri Lanka..." autocomplete="off">
                <button id="clear-search">√ó</button>
            </div>
            <div id="search-results"></div>
        </div>
    </div>

    <div class="controls-panel">
        <div class="controls-header" id="controls-toggle">
            <h3>Map Controls</h3>
            <button class="controls-toggle-btn">‚ñº</button>
        </div>
        <div class="controls-content">
            <div class="layer-section">
                <h4>Base Map</h4>
                <div class="layer-toggle">
                    <span class="layer-label">Street Map</span>
                    <label class="toggle-switch">
                        <input type="radio" name="basemap" id="basemap-osm" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="layer-toggle">
                    <span class="layer-label">Satellite</span>
                    <label class="toggle-switch">
                        <input type="radio" name="basemap" id="basemap-satellite">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="layer-toggle">
                    <span class="layer-label">Hybrid (Sat + Labels)</span>
                    <label class="toggle-switch">
                        <input type="radio" name="basemap" id="basemap-hybrid">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="layer-section">
                <h4>Hazard Layers</h4>
                <div class="layer-toggle">
                    <span class="layer-label">LHZM 1:10,000</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="layer-10k" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="layer-toggle">
                    <span class="layer-label">LHZM 1:50,000</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="layer-50k" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="layer-toggle">
                    <span class="layer-label">Reported Incidents</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="layer-warning" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="layer-toggle">
                    <span class="layer-label">Satellite Detected Landslides</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="layer-satellite-ls">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="layer-section">
                <h4>Terrain View</h4>
                <div class="layer-toggle">
                    <span class="layer-label">Hillshade (3D Relief)</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="layer-hillshade">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <button id="locate-btn" class="action-btn">
                üìç Find My Location
            </button>
        </div>
    </div>

    <div class="legend">
        <div class="legend-header" id="legend-toggle">
            <h4>Hazard Zones</h4>
            <button class="legend-toggle">‚ñº</button>
        </div>
        <div class="legend-content">
            <i style="background: #ec4899"></i> Recent Incidents<br>
            <i style="background: #22c55e"></i> Past Incidents<br>
            <i style="background: #f97316"></i> Satellite Detected Landslides<br>
            <hr style="border: 0; border-top: 1px solid rgba(139, 92, 246, 0.3); margin: 5px 0;">
            <i style="background: rgb(99, 0, 0)"></i> Landslide most likely to occur<br>
            <i style="background: rgb(230, 0, 0)"></i> Landslides have been occurred in the Past<br>
            <i style="background: rgb(254, 172, 0)"></i> Landslide are to be expected<br>
            <i style="background: rgb(254, 244, 141)"></i> Modest level of landslide hazard exist<br>
            <i style="background: rgb(165, 254, 164)"></i> Landslides not likely to occur<br>
            <i style="background: rgb(128, 128, 128)"></i> Not mapped<br>
            <i style="background: rgb(165, 0, 230)"></i> Subsidence & Rockfall<br>
            <i style="background: rgb(115, 223, 255)"></i> Water Bodies<br>
        </div>
    </div>

    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>

    <script>
        // Browser caching and performance optimization
        let protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);

        // Enable aggressive browser caching
        const cacheConfig = {
            maxSize: 50 * 1024 * 1024, // 50MB cache
        };

        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap contributors'
                    }
                    // Satellite, hillshade, and hybrid-labels will be loaded on-demand
                },
                layers: [
                    {
                        id: 'osm',
                        type: 'raster',
                        source: 'osm',
                        layout: { visibility: 'visible' }
                    }
                    // Other layers loaded on-demand
                ]
            },
            center: [80.7718, 7.8731],
            zoom: 8,
            maxBounds: [
                [79.5, 5.9], // Southwest coordinates (Sri Lanka bounds)
                [82.0, 9.9]  // Northeast coordinates
            ],
            minZoom: 7,
            maxZoom: 18,
            hash: true, // Enable URL hash for sharing map position
            attributionControl: true,
            preserveDrawingBuffer: false, // Better performance
            renderWorldCopies: false, // Don't render map copies
            touchZoomRotate: true,
            touchPitch: true, // Enable pitch for 3D view
            dragRotate: true, // Enable rotation
            pitchWithRotate: true
        });

        map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'bottom-left');

        const hazardColorMatch = [
            "match",
            ["get", "Hazard"],
            "Landslides not likely to occur", "rgb(165, 254, 164)",
            "Modest level of landslide hazard exist", "rgb(254, 244, 141)",
            "Landslide are to be expected", "rgb(254, 172, 0)",
            "Landslide most likely to occur", "rgb(99, 0, 0)",
            "Water Bodies", "rgb(115, 223, 255)",
            "Landslides have been occurred in the Past", "rgb(230, 0, 0)",
            "Inaccessible slopes", "rgb(128, 128, 128)",
            "Subsidence & Rockfall", "rgb(165, 0, 230)",
            "rgb(52, 52, 52)"
        ];

        map.on('load', () => {
            document.getElementById('loading-indicator').classList.remove('active');

            // Only load 1:50k initially (lighter, faster)
            map.addSource('hazard_50k', {
                type: 'vector',
                url: 'pmtiles://https://pub-ee4ee353c00e4a7dbe74d0b5339e82b0.r2.dev/LHMP_50000.pmtiles',
                attribution: 'NBRO',
                minzoom: 7,
                maxzoom: 14
            });

            // 1:10k loaded on-demand (when zoomed in or toggled)

            map.addSource('early_warning', {
                type: 'geojson',
                data: 'early_warning.geojson'
            });

            map.addSource('satellite_landslides', {
                type: 'geojson',
                data: 'satellite_landslides.geojson'
            });

            map.addLayer({
                'id': 'hazard_50k_fill',
                'type': 'fill',
                'source': 'hazard_50k',
                'source-layer': 'hazard_50k',
                'paint': {
                    'fill-color': hazardColorMatch,
                    'fill-opacity': 0.6, // Reduced opacity to let hillshade show through
                    'fill-outline-color': 'rgba(0,0,0,0.1)' // Softer outline
                }
            });

            // 1:10k layer - lazy loaded (saves bandwidth on mobile)
            window.hazard10kLoaded = false;
            window.loadHazard10k = function () {
                if (!window.hazard10kLoaded) {
                    map.addSource('hazard_10k', {
                        type: 'vector',
                        url: 'pmtiles://https://pub-ee4ee353c00e4a7dbe74d0b5339e82b0.r2.dev/LHZM_10000.pmtiles',
                        attribution: 'NBRO',
                        minzoom: 12,
                        maxzoom: 18
                    });

                    map.addLayer({
                        'id': 'hazard_10k_fill',
                        'type': 'fill',
                        'source': 'hazard_10k',
                        'source-layer': 'hazard_10k',
                        'paint': {
                            'fill-color': hazardColorMatch,
                            'fill-opacity': 0.6,
                            'fill-outline-color': 'rgba(0,0,0,0.1)'
                        },
                        'layout': {
                            'visibility': document.getElementById('layer-10k').checked ? 'visible' : 'none'
                        }
                    });

                    map.on('click', 'hazard_10k_fill', showPopup);
                    map.on('mouseenter', 'hazard_10k_fill', () => map.getCanvas().style.cursor = 'pointer');
                    map.on('mouseleave', 'hazard_10k_fill', () => map.getCanvas().style.cursor = '');

                    window.hazard10kLoaded = true;
                }
            }

            // Auto-load 1:10k when zoomed in (zoom level 12+)
            map.on('zoom', () => {
                if (map.getZoom() >= 12 && !window.hazard10kLoaded) {
                    window.loadHazard10k();
                }
            });

            map.addLayer({
                'id': 'early_warning_points',
                'type': 'circle',
                'source': 'early_warning',
                'paint': {
                    'circle-radius': 6,
                    'circle-color': [
                        'match',
                        ['get', 'status'],
                        'recent', '#ec4899', // Pink for recent
                        '#22c55e'  // Green for old
                    ],
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                },
                'layout': {
                    'visibility': 'visible'
                }
            });

            // Satellite Landslides (Polygons)
            map.addLayer({
                'id': 'satellite_polygons',
                'type': 'line',
                'source': 'satellite_landslides',
                'filter': ['==', ['get', 'type'], 'landslide_polygon'],
                'paint': {
                    'line-color': '#f97316', // Orange
                    'line-width': 2
                },
                'layout': { 'visibility': 'none' }
            });

            // Satellite Landslides (Points)
            map.addLayer({
                'id': 'satellite_points',
                'type': 'circle',
                'source': 'satellite_landslides',
                'filter': ['==', ['get', 'type'], 'incident_point'],
                'paint': {
                    'circle-radius': 5,
                    'circle-color': '#f97316', // Orange
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#ffffff'
                },
                'layout': { 'visibility': 'none' }
            });

            map.on('click', 'hazard_50k_fill', showPopup);
            map.on('click', 'early_warning_points', showPopup);
            map.on('click', 'satellite_points', showPopup);
            map.on('click', 'satellite_polygons', showPopup);

            map.on('mouseenter', 'hazard_50k_fill', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'hazard_50k_fill', () => map.getCanvas().style.cursor = '');
            map.on('mouseenter', 'early_warning_points', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'early_warning_points', () => map.getCanvas().style.cursor = '');
            map.on('mouseenter', 'satellite_points', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'satellite_points', () => map.getCanvas().style.cursor = '');
            map.on('mouseenter', 'satellite_polygons', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'satellite_polygons', () => map.getCanvas().style.cursor = '');
        });

        function showPopup(e) {
            const coordinates = e.lngLat;
            const props = e.features[0].properties;

            let content = '<div class="popup-title">Feature Information</div>';
            content += '<div class="popup-info">';
            for (const key in props) {
                if (props[key] !== null) {
                    content += `<b>${key}:</b> ${props[key]}<br>`;
                }
            }
            content += '</div>';

            new maplibregl.Popup()
                .setLngLat(coordinates)
                .setHTML(content)
                .addTo(map);
        }

        document.getElementById('layer-10k').addEventListener('change', (e) => {
            // Load 1:10k on demand if user toggles it
            if (e.target.checked && !window.hazard10kLoaded) {
                window.loadHazard10k();
            }
            if (window.hazard10kLoaded) {
                map.setLayoutProperty('hazard_10k_fill', 'visibility', e.target.checked ? 'visible' : 'none');
            }

            // Dynamic zoom restriction: 1:10k supports up to zoom 18
            updateMaxZoom();
        });

        document.getElementById('layer-50k').addEventListener('change', (e) => {
            map.setLayoutProperty('hazard_50k_fill', 'visibility', e.target.checked ? 'visible' : 'none');
            // Dynamic zoom restriction: 1:50k supports up to zoom 14
            updateMaxZoom();
        });

        // Update max zoom based on active layers
        function updateMaxZoom() {
            const is10kActive = document.getElementById('layer-10k').checked;
            const is50kActive = document.getElementById('layer-50k').checked;

            if (is10kActive) {
                // 1:10k layer is on, allow zoom to 18
                map.setMaxZoom(18);
            } else if (is50kActive) {
                // Only 1:50k layer is on, restrict zoom to 14
                map.setMaxZoom(14);
            } else {
                // No hazard layers, default max zoom
                map.setMaxZoom(18);
            }

            // If current zoom exceeds new max, zoom out
            if (map.getZoom() > map.getMaxZoom()) {
                map.setZoom(map.getMaxZoom());
            }
        }

        document.getElementById('layer-warning').addEventListener('change', (e) => {
            map.setLayoutProperty('early_warning_points', 'visibility', e.target.checked ? 'visible' : 'none');
        });

        document.getElementById('layer-satellite-ls').addEventListener('change', (e) => {
            const visibility = e.target.checked ? 'visible' : 'none';
            map.setLayoutProperty('satellite_polygons', 'visibility', visibility);
            map.setLayoutProperty('satellite_points', 'visibility', visibility);
        });

        document.getElementById('layer-hillshade').addEventListener('change', (e) => {
            // Smart hillshade mode: disable basemaps to save bandwidth
            ensureLayersLoaded(['hillshade'], () => {
                map.setLayoutProperty('hillshade', 'visibility', e.target.checked ? 'visible' : 'none');

                if (e.target.checked) {
                    // When hillshade is ON, turn off basemap for better performance
                    map.setLayoutProperty('osm', 'visibility', 'none');
                    if (satelliteLoaded) map.setLayoutProperty('satellite', 'visibility', 'none');
                    if (hybridLabelsLoaded) map.setLayoutProperty('hybrid-labels', 'visibility', 'none');

                    // Update radio buttons UI to match
                    document.querySelectorAll('input[name="basemap"]').forEach(r => r.checked = false);
                } else {
                    // When hillshade is OFF, restore street map
                    document.getElementById('basemap-osm').checked = true;
                    map.setLayoutProperty('osm', 'visibility', 'visible');
                }
            });
        });

        // Basemap toggle controls with lazy loading
        let satelliteLoaded = false;
        let hillshadeLoaded = false;
        let hybridLabelsLoaded = false;

        function ensureLayersLoaded(layers, callback) {
            let toLoad = [];

            if (layers.includes('satellite') && !satelliteLoaded) {
                toLoad.push({
                    source: 'satellite',
                    config: {
                        type: 'raster',
                        tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
                        tileSize: 256,
                        attribution: 'Tiles &copy; Esri'
                    },
                    layer: {
                        id: 'satellite',
                        type: 'raster',
                        source: 'satellite',
                        layout: { visibility: 'none' }
                    }
                });
            }

            if (layers.includes('hillshade') && !hillshadeLoaded) {
                toLoad.push({
                    source: 'hillshade',
                    config: {
                        type: 'raster',
                        tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}'],
                        tileSize: 256,
                        attribution: 'Tiles &copy; Esri',
                        maxzoom: 14
                    },
                    layer: {
                        id: 'hillshade',
                        type: 'raster',
                        source: 'hillshade',
                        paint: {
                            'raster-opacity': 1.0,
                            'raster-contrast': 0.1
                        },
                        layout: { visibility: 'none' }
                    }
                });
            }

            if (layers.includes('hybrid-labels') && !hybridLabelsLoaded) {
                toLoad.push({
                    source: 'hybrid-labels',
                    config: {
                        type: 'raster',
                        tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}'],
                        tileSize: 256,
                        attribution: 'Tiles &copy; Esri'
                    },
                    layer: {
                        id: 'hybrid-labels',
                        type: 'raster',
                        source: 'hybrid-labels',
                        layout: { visibility: 'none' }
                    }
                });
            }

            if (toLoad.length > 0) {
                toLoad.forEach(item => {
                    if (!map.getSource(item.source)) {
                        map.addSource(item.source, item.config);
                        map.addLayer(item.layer, 'hazard_50k_fill'); // Add before hazard layers
                    }
                });

                if (layers.includes('satellite')) satelliteLoaded = true;
                if (layers.includes('hillshade')) hillshadeLoaded = true;
                if (layers.includes('hybrid-labels')) hybridLabelsLoaded = true;
            }

            if (callback) callback();
        }

        document.getElementById('basemap-osm').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.setLayoutProperty('osm', 'visibility', 'visible');
                if (satelliteLoaded) map.setLayoutProperty('satellite', 'visibility', 'none');
                if (hybridLabelsLoaded) map.setLayoutProperty('hybrid-labels', 'visibility', 'none');
            }
        });

        document.getElementById('basemap-satellite').addEventListener('change', (e) => {
            if (e.target.checked) {
                ensureLayersLoaded(['satellite'], () => {
                    map.setLayoutProperty('osm', 'visibility', 'none');
                    map.setLayoutProperty('satellite', 'visibility', 'visible');
                    if (hybridLabelsLoaded) map.setLayoutProperty('hybrid-labels', 'visibility', 'none');
                });
            }
        });

        document.getElementById('basemap-hybrid').addEventListener('change', (e) => {
            if (e.target.checked) {
                ensureLayersLoaded(['satellite', 'hybrid-labels'], () => {
                    map.setLayoutProperty('osm', 'visibility', 'none');
                    map.setLayoutProperty('satellite', 'visibility', 'visible');
                    map.setLayoutProperty('hybrid-labels', 'visibility', 'visible');
                });
            }
        });

        document.getElementById('locate-btn').addEventListener('click', () => {
            if ("geolocation" in navigator) {
                document.getElementById('loading-indicator').classList.add('active');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        document.getElementById('loading-indicator').classList.remove('active');
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        map.flyTo({ center: [lng, lat], zoom: 14 });
                        new maplibregl.Marker({ color: '#8b5cf6' })
                            .setLngLat([lng, lat])
                            .setPopup(new maplibregl.Popup().setHTML('<b>You are here</b>'))
                            .addTo(map)
                            .togglePopup();
                    },
                    (error) => {
                        document.getElementById('loading-indicator').classList.remove('active');
                        alert('Unable to get your location: ' + error.message);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                alert('Geolocation is not supported by your browser');
            }
        });

        // Search functionality using Nominatim API
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const clearBtn = document.getElementById('clear-search');
        let searchTimeout;
        let searchMarker;

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();

            if (query.length > 0) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
                searchResults.style.display = 'none';
                return;
            }

            clearTimeout(searchTimeout);

            if (query.length < 3) return;

            searchTimeout = setTimeout(() => {
                searchLocation(query);
            }, 500);
        });

        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            clearBtn.style.display = 'none';
            searchResults.style.display = 'none';
            if (searchMarker) {
                searchMarker.remove();
            }
        });

        async function searchLocation(query) {
            try {
                // Use browser cache to reduce API calls
                const cacheKey = `geocode_${query}`;
                const cached = sessionStorage.getItem(cacheKey);

                if (cached) {
                    const data = JSON.parse(cached);
                    displayResults(data);
                    return;
                }

                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Sri Lanka')}&limit=5&countrycodes=lk`
                );
                const data = await response.json();

                // Cache the results
                if (data.length > 0) {
                    sessionStorage.setItem(cacheKey, JSON.stringify(data));
                    displayResults(data);
                } else {
                    showNoResults();
                }
            } catch (error) {
                console.error('Search error:', error);
                showNoResults();
            }
        }

        function displayResults(results) {
            searchResults.innerHTML = '';
            searchResults.style.display = 'block';

            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';

                const title = document.createElement('div');
                title.className = 'result-title';
                title.textContent = result.display_name.split(',')[0];

                const subtitle = document.createElement('div');
                subtitle.className = 'result-subtitle';
                subtitle.textContent = result.display_name.split(',').slice(1).join(',').trim();

                item.appendChild(title);
                item.appendChild(subtitle);

                item.addEventListener('click', () => {
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);

                    map.flyTo({
                        center: [lon, lat],
                        zoom: 14,
                        duration: 1500
                    });

                    if (searchMarker) {
                        searchMarker.remove();
                    }

                    searchMarker = new maplibregl.Marker({ color: '#06b6d4' })
                        .setLngLat([lon, lat])
                        .setPopup(
                            new maplibregl.Popup().setHTML(
                                `<div class="popup-title">${result.display_name.split(',')[0]}</div>
                                <div class="popup-info">${subtitle.textContent}</div>`
                            )
                        )
                        .addTo(map)
                        .togglePopup();

                    searchResults.style.display = 'none';
                    searchInput.value = result.display_name.split(',')[0];
                });

                searchResults.appendChild(item);
            });
        }

        function showNoResults() {
            searchResults.innerHTML = '<div class="no-results">No results found in Sri Lanka</div>';
            searchResults.style.display = 'block';
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box')) {
                searchResults.style.display = 'none';
            }
        });

        // Legend toggle functionality
        const legendToggle = document.getElementById('legend-toggle');
        const legend = document.querySelector('.legend');

        legendToggle.addEventListener('click', () => {
            legend.classList.toggle('collapsed');

            // Save preference to localStorage
            if (legend.classList.contains('collapsed')) {
                localStorage.setItem('legendCollapsed', 'true');
            } else {
                localStorage.setItem('legendCollapsed', 'false');
            }
        });

        // Restore legend state on page load
        window.addEventListener('load', () => {
            const isLegendCollapsed = localStorage.getItem('legendCollapsed') === 'true';
            if (isLegendCollapsed) {
                legend.classList.add('collapsed');
            }

            const isControlsCollapsed = localStorage.getItem('controlsCollapsed') === 'true';
            if (isControlsCollapsed) {
                controlsPanel.classList.add('collapsed');
            }
        });

        // Controls toggle functionality
        const controlsToggle = document.getElementById('controls-toggle');
        const controlsPanel = document.querySelector('.controls-panel');

        controlsToggle.addEventListener('click', () => {
            controlsPanel.classList.toggle('collapsed');

            // Save preference to localStorage
            if (controlsPanel.classList.contains('collapsed')) {
                localStorage.setItem('controlsCollapsed', 'true');
            } else {
                localStorage.setItem('controlsCollapsed', 'false');
            }
        });
    </script>
</body>

</html>