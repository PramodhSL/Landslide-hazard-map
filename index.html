<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#8b5cf6">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description"
        content="Landslide Hazard Zonation Map of Sri Lanka - View hazard zones, incidents, and terrain data">
    <title>Landslide Hazard Zonation Map</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link href="./lib/maplibre-gl.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #0f172a;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
            touch-action: none;
            /* Improves touch handling on mobile */
        }

        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(15px);
            padding: 2.5rem 3.5rem;
            border-radius: 20px;
            border: 2px solid rgba(139, 92, 246, 0.4);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.7);
            text-align: center;
            z-index: 10000;
            display: none;
        }

        #loading-indicator.active {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 1.5rem;
            border: 5px solid rgba(139, 92, 246, 0.2);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #loading-indicator p {
            color: #e2e8f0;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        #loading-indicator small {
            color: #94a3b8;
            font-size: 0.85rem;
        }

        /* Progress Bar */
        .progress-container {
            width: 200px;
            height: 6px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 3px;
            margin: 1rem auto 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #8b5cf6, #06b6d4);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        #loading-status {
            color: #94a3b8;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        /* Search Box */
        .search-container {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 2000;
            /* Ensure search is above everything */
            width: 320px;
            max-width: calc(100vw - 2rem);
        }

        .search-box {
            position: relative;
            background: rgba(15, 23, 42, 0.97);
            backdrop-filter: blur(12px);
            border-radius: 14px;
            border: 1px solid rgba(139, 92, 246, 0.35);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .search-input-wrapper {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            gap: 0.75rem;
        }

        .search-icon {
            color: #8b5cf6;
            font-size: 1.2rem;
        }

        #search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #e2e8f0;
            font-size: 0.95rem;
            outline: none;
        }

        #search-input::placeholder {
            color: #64748b;
        }

        #clear-search {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0.25rem;
            display: none;
        }

        #clear-search:hover {
            color: #e2e8f0;
        }

        /* 404 Prevention: Ensure favicon doesn't cause errors */
        link[rel="icon"] {
            display: none;
        }

        #search-results {
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            display: none;
            scroll-behavior: smooth;
            /* Smooth scroll */
        }

        .search-result-item {
            padding: 0.875rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: rgba(139, 92, 246, 0.2);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .result-title {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .result-subtitle {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .no-results {
            padding: 1.5rem 1rem;
            text-align: center;
            color: #64748b;
            font-size: 0.9rem;
        }

        .controls-panel {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(15, 23, 42, 0.97);
            backdrop-filter: blur(12px);
            border-radius: 18px;
            padding: 1.5rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(139, 92, 246, 0.35);
            /* Ensure Controls Panel is ABOVE FABs (1000) and Search (2000) if expanded? 
               Actually, Search (2000) should be top. Controls Panel (1500). FABs (1000). */
            z-index: 1500;
            min-width: 280px;
            max-width: 90vw;
        }

        .controls-panel h3 {
            color: #e2e8f0;
            font-size: 1.15rem;
            margin: 0;
            font-weight: 700;
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            flex-grow: 1;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            cursor: pointer;
            user-select: none;
        }

        .controls-panel.collapsed .controls-header {
            margin-bottom: 0;
        }

        .controls-toggle-btn {
            background: none;
            border: none;
            color: #8b5cf6;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: transform 0.3s ease;
        }

        .controls-panel.collapsed .controls-toggle-btn {
            transform: rotate(180deg);
        }

        .controls-content {
            transition: all 0.3s ease;
        }

        .controls-panel.collapsed .controls-content {
            display: none;
        }

        .controls-panel.collapsed {
            padding: 1rem 1.5rem;
        }

        .layer-section {
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
            margin-bottom: 0.5rem;
        }

        .layer-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .layer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            cursor: pointer;
            user-select: none;
            /* Fix conflict with FABs on mobile if they overlap */
            position: relative;
            z-index: 2;
        }

        .layer-header h4 {
            color: #cbd5e1;
            font-size: 0.95rem;
            margin: 0;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .layer-header .icon {
            color: #8b5cf6;
            transition: transform 0.3s ease;
            font-size: 0.8rem;
        }

        .layer-section.active .layer-header .icon {
            transform: rotate(180deg);
        }

        .layer-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .layer-section.active .layer-content {
            max-height: 500px;
            /* Arbitrary large height */
            transition: max-height 0.5s ease-in;
            padding-bottom: 1rem;
        }

        .layer-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 0.85rem;
        }

        .opacity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
            padding-left: 2px;
        }

        .opacity-label {
            color: #94a3b8;
            font-size: 0.8rem;
            width: 50px;
        }

        .opacity-control input[type="range"] {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: #334155;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
        }

        .opacity-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
            border: 2px solid #1e293b;
        }

        .layer-label {
            color: #cbd5e1;
            font-size: 0.95rem;
            font-weight: 500;
            flex: 1;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #334155;
            transition: 0.3s ease;
            border-radius: 28px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background: linear-gradient(135deg, #64748b, #475569);
            transition: 0.3s ease;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        input:checked+.slider {
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);
        }

        input:checked+.slider:before {
            transform: translateX(24px);
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .fab-container {
            position: fixed;
            bottom: 8rem;
            /* Positioned ABOVE the zoom controls (which are ~bottom: 2rem) */
            left: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 1000;
        }

        .fab-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .fab-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .fab-btn:active {
            transform: scale(0.95);
        }

        .fab-tooltip {
            position: absolute;
            left: 70px;
            background: rgba(15, 23, 42, 0.9);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            backdrop-filter: blur(4px);
        }

        .fab-btn:hover .fab-tooltip {
            opacity: 1;
        }

        #locate-btn {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
        }

        #measure-btn {
            background: linear-gradient(135deg, #10b981, #0ea5e9);
        }

        #measure-btn.active {
            background: linear-gradient(135deg, #ef4444, #f59e0b);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Measurement Result Box - Updated Position */
        #measure-result {
            position: fixed;
            bottom: 6rem;
            /* Above the FABs */
            left: 1rem;
            z-index: 1000;
            min-width: 160px;
        }

        .legend {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem 1.25rem;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            line-height: 26px;
            color: #cbd5e1;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .legend.collapsed {
            padding: 0;
            overflow: hidden;
        }

        .legend.collapsed .legend-content {
            display: none;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            cursor: pointer;
            user-select: none;
        }

        .legend.collapsed .legend-header {
            margin-bottom: 0;
            padding: 0.75rem 1rem;
        }

        .legend h4 {
            margin: 0;
            color: #e2e8f0;
            font-size: 1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #8b5cf6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .legend-toggle {
            background: none;
            border: none;
            color: #8b5cf6;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: transform 0.3s ease;
        }

        .legend.collapsed .legend-toggle {
            transform: rotate(180deg);
        }

        .legend-content {
            transition: all 0.3s ease;
        }

        .legend i {
            width: 20px;
            height: 20px;
            float: left;
            margin-right: 10px;
            opacity: 0.85;
            border-radius: 3px;
        }

        .maplibregl-ctrl-group {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            /* Slightly rounded */
            overflow: hidden;
        }

        .maplibregl-ctrl-group button {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(6, 182, 212, 0.15)) !important;
            /* Force gradient */
            color: #8b5cf6 !important;
            /* Force purple icon color */
            width: 32px;
            height: 32px;
            border: 0 !important;
        }

        .maplibregl-ctrl-group button:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.4), rgba(6, 182, 212, 0.4)) !important;
        }

        .maplibregl-ctrl-group button+button {
            border-top: 1px solid rgba(139, 92, 246, 0.3) !important;
        }

        /* FIX: Use filter to turn black SVG icons into purple/white */
        .maplibregl-ctrl-icon {
            filter: invert(44%) sepia(34%) saturate(735%) hue-rotate(224deg) brightness(97%) contrast(92%);
            /* Purple #8b5cf6 */
        }

        .maplibregl-ctrl-group button:hover .maplibregl-ctrl-icon {
            filter: invert(100%) sepia(100%) saturate(0%) hue-rotate(288deg) brightness(102%) contrast(102%);
            /* White on hover */
        }

        .maplibregl-popup-content {
            background: rgba(15, 23, 42, 0.97);
            color: #e2e8f0;
            border-radius: 14px;
            border: 1px solid rgba(139, 92, 246, 0.35);
            padding: 1.25rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .maplibregl-popup-tip {
            border-top-color: rgba(15, 23, 42, 0.97);
        }

        .popup-title {
            font-weight: 700;
            font-size: 1.05rem;
            color: #8b5cf6;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        }

        .popup-info {
            color: #cbd5e1;
        }

        .popup-info b {
            color: #06b6d4;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .search-container {
                width: calc(100vw - 2rem);
                top: 0.5rem;
                left: 0.5rem;
            }

            .search-box {
                border-radius: 12px;
            }

            .search-input-wrapper {
                padding: 0.65rem 0.85rem;
            }

            #search-input {
                font-size: 0.9rem;
            }

            #search-results {
                max-height: 200px;
            }

            .search-result-item {
                padding: 0.75rem 0.85rem;
            }

            .result-title {
                font-size: 0.85rem;
            }

            .result-subtitle {
                font-size: 0.75rem;
            }

            /* Mobile: Hide FABs when Controls Panel is expanded? 
               Or move them. Let's move them to top-left under Search on mobile. */
            .fab-container {
                bottom: auto;
                top: 5rem;
                /* Below search bar */
                left: 0.5rem;
            }

            /* Larger FABs for easier touch on mobile */
            .fab-btn {
                width: 64px;
                height: 64px;
                font-size: 1.7rem;
            }

            /* Ensure controls panel takes precedence */
            .controls-panel {
                z-index: 3000 !important;
                /* Topmost on mobile */
            }

            .controls-panel {
                top: auto;
                bottom: 0;
                right: 0;
                left: 0;
                max-width: none;
                padding: 1rem;
                border-radius: 18px 18px 0 0;
                border-bottom: none;
                max-height: 50vh;
                overflow-y: auto;
            }

            .controls-panel h3 {
                font-size: 1rem;
                margin: 0;
            }

            .controls-header {
                margin-bottom: 1rem;
            }

            .controls-panel.collapsed .controls-header {
                margin-bottom: 0;
            }

            .layer-section h4 {
                font-size: 0.85rem;
                margin-bottom: 0.6rem;
            }

            .layer-toggle {
                margin-bottom: 0.85rem;
            }

            .layer-label {
                font-size: 0.9rem;
            }

            .action-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                margin-top: 1rem;
            }

            .legend {
                bottom: auto;
                top: 4.5rem;
                right: 0.5rem;
                left: auto;
                font-size: 0.75rem;
                padding: 0.75rem 0.9rem;
                line-height: 22px;
                max-width: calc(100vw - 1rem);
            }

            .legend h4 {
                font-size: 0.9rem;
                margin-bottom: 0.6rem;
            }

            .legend i {
                width: 14px;
                height: 14px;
                margin-right: 8px;
            }

            .legend br {
                line-height: 20px;
            }

            .maplibregl-ctrl-bottom-left {
                bottom: 52vh;
            }
        }

        @media (max-width: 480px) {
            .search-container {
                top: 0.5rem;
                left: 0.5rem;
                right: 0.5rem;
                width: auto;
            }

            .controls-panel {
                padding: 0.85rem;
            }

            .legend {
                top: 4rem;
                right: 0.5rem;
                padding: 0.65rem 0.75rem;
                font-size: 0.7rem;
                line-height: 20px;
            }

            .legend h4 {
                font-size: 0.85rem;
            }

            .legend i {
                width: 12px;
                height: 12px;
                margin-right: 6px;
            }
        }
    </style>
</head>

<body>
    <div id="loading-indicator" class="active">
        <div class="spinner"></div>
        <p>Loading Maps...</p>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="loading-status">Initializing...</div>
    </div>

    <div id="map"></div>

    <!-- Search Box -->
    <div class="search-container">
        <div class="search-box">
            <div class="search-input-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="search-input" placeholder="Search location in Sri Lanka..." autocomplete="off">
                <button id="clear-search">√ó</button>
            </div>
            <div id="search-results"></div>
        </div>
    </div>

    <div class="controls-panel">
        <div class="controls-header" id="controls-toggle">
            <h3>Map Controls</h3>
            <button class="controls-toggle-btn">‚ñº</button>
        </div>
        <div class="controls-content">
            <!-- Base Map Section -->
            <div class="layer-section active"> <!-- Open by default -->
                <div class="layer-header">
                    <h4>Base Map</h4>
                    <span class="icon">‚ñº</span>
                </div>
                <div class="layer-content">
                    <div class="layer-toggle">
                        <span class="layer-label">Street Map</span>
                        <label class="toggle-switch">
                            <input type="radio" name="basemap" id="basemap-osm" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="layer-toggle">
                        <span class="layer-label">Satellite</span>
                        <label class="toggle-switch">
                            <input type="radio" name="basemap" id="basemap-satellite">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="layer-toggle">
                        <span class="layer-label">Hybrid (Sat + Labels)</span>
                        <label class="toggle-switch">
                            <input type="radio" name="basemap" id="basemap-hybrid">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Hazard Layers Section -->
            <div class="layer-section active"> <!-- Open by default -->
                <div class="layer-header">
                    <h4>Hazard Layers</h4>
                    <span class="icon">‚ñº</span>
                </div>
                <div class="layer-content">
                    <div class="layer-toggle">
                        <span class="layer-label">LHZM 1:10,000</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="layer-10k" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="opacity-control">
                        <span class="opacity-label">Opacity</span>
                        <input type="range" id="opacity-10k" min="0" max="100" value="60">
                    </div>
                    <div class="layer-toggle">
                        <span class="layer-label">LHZM 1:50,000</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="layer-50k" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="opacity-control">
                        <span class="opacity-label">Opacity</span>
                        <input type="range" id="opacity-50k" min="0" max="100" value="60">
                    </div>
                    <div class="layer-toggle">
                        <span class="layer-label">Reported Incidents</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="layer-warning" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="layer-toggle">
                        <span class="layer-label">Satellite Detected Landslides</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="layer-satellite-ls">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="fab-container">
        <button id="locate-btn" class="fab-btn" title="Find My Location">
            üìç
            <span class="fab-tooltip">Find Location</span>
        </button>
        <button id="bookmark-btn" class="fab-btn" title="Bookmarks"
            style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            ‚≠ê
            <span class="fab-tooltip">Bookmarks</span>
        </button>
        <button id="measure-btn" class="fab-btn" title="Measure Distance">
            üìè
            <span class="fab-tooltip">Measure Distance</span>
        </button>
        <button id="view3d-btn" class="fab-btn" title="Toggle 3D View"
            style="background: linear-gradient(135deg, #f59e0b, #ef4444);">
            üèîÔ∏è
            <span class="fab-tooltip">3D Terrain View</span>
        </button>
        <button id="offline-btn" class="fab-btn" title="Download for Offline"
            style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
            üì•
            <span class="fab-tooltip">Download for Offline</span>
        </button>
    </div>

    <!-- Compass Indicator (shows in 3D mode) -->
    <div id="compass-indicator"
        style="display:none; position:fixed; top:4.5rem; right:0.75rem; z-index:2000; cursor:pointer;">
        <div id="compass-needle"
            style="width:48px; height:48px; background:rgba(15,23,42,0.9); border-radius:50%; border:2px solid rgba(139,92,246,0.6); display:flex; align-items:center; justify-content:center; box-shadow:0 4px 15px rgba(0,0,0,0.3); transition: transform 0.3s;">
            <span style="font-size:1.5rem; transform-origin:center;">üß≠</span>
        </div>
        <div style="text-align:center; font-size:0.65rem; color:#94a3b8; margin-top:2px;">Tap to reset</div>
    </div>

    <!-- Bookmarks Panel -->
    <div id="bookmarks-panel"
        style="display:none; position:fixed; bottom:5rem; left:0.75rem; z-index:3000; background:rgba(15,23,42,0.98); border-radius:12px; border:1px solid rgba(139,92,246,0.4); box-shadow:0 4px 20px rgba(0,0,0,0.4); width:280px; max-height:300px; overflow:hidden;">
        <div
            style="padding:12px 16px; border-bottom:1px solid rgba(139,92,246,0.3); display:flex; justify-content:space-between; align-items:center;">
            <span style="color:#e2e8f0; font-weight:600; font-size:0.9rem;">‚≠ê Saved Locations</span>
            <button id="close-bookmarks"
                style="background:none; border:none; color:#94a3b8; cursor:pointer; font-size:1.2rem;">√ó</button>
        </div>
        <div id="bookmarks-list" style="max-height:200px; overflow-y:auto; padding:8px;"></div>
        <div style="padding:8px 12px; border-top:1px solid rgba(139,92,246,0.3);">
            <button id="save-current-location"
                style="width:100%; padding:10px; background:linear-gradient(135deg, #10b981, #059669); color:white; border:none; border-radius:8px; cursor:pointer; font-size:0.85rem; font-weight:500;">
                ‚ûï Save Current Location
            </button>
        </div>
    </div>

    <!-- Offline Status Indicator -->
    <div id="offline-status"
        style="display:none; position:fixed; top:1rem; left:50%; transform:translateX(-50%); z-index:3000; background:rgba(15,23,42,0.95); color:#e2e8f0; padding:8px 16px; border-radius:20px; font-size:0.85rem; border:1px solid rgba(139,92,246,0.4); box-shadow:0 4px 15px rgba(0,0,0,0.3);">
        <span id="offline-status-text">üî¥ Offline Mode</span>
    </div>

    <!-- Download Progress Modal -->
    <div id="download-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; justify-content:center; align-items:center;">
        <div
            style="background:rgba(15,23,42,0.98); padding:2rem; border-radius:16px; border:1px solid rgba(139,92,246,0.4); text-align:center; max-width:300px;">
            <div style="font-size:2rem; margin-bottom:1rem;">üì•</div>
            <div style="color:#e2e8f0; font-weight:600; margin-bottom:0.5rem;">Downloading Maps</div>
            <div id="download-status" style="color:#94a3b8; font-size:0.85rem; margin-bottom:1rem;">Preparing...</div>
            <div class="progress-container" style="width:100%; margin-bottom:1rem;">
                <div id="download-progress" class="progress-bar" style="width:0%;"></div>
            </div>
            <button id="cancel-download"
                style="background:rgba(239,68,68,0.2); color:#ef4444; border:1px solid rgba(239,68,68,0.4); padding:8px 16px; border-radius:8px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <div id="measure-result"
        style="display:none; color: #e2e8f0; font-size: 0.9rem; text-align: center; background: rgba(15,23,42,0.9); padding: 12px; border-radius: 12px; border: 1px solid rgba(16,185,129,0.4); box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
        <div style="font-weight:600; margin-bottom:4px;">Distance</div>
        <div style="font-size:1.2rem; margin-bottom:8px;"><span id="distance-value">0.00</span> <span
                style="font-size:0.9rem; color:#94a3b8;">km</span></div>
        <button id="clear-measure"
            style="display:block; width:100%; padding: 6px; background:rgba(255,255,255,0.1); border:none; border-radius:6px; color:#e2e8f0; cursor:pointer; font-size:0.85rem; transition:background 0.2s;">Clear</button>
    </div>

    <div class="legend" id="legend">
        <div class="legend-header" id="legend-toggle">
            <h4>Hazard Zones</h4>
            <button class="legend-toggle">‚ñº</button>
        </div>
        <div class="legend-content">
            <i style="background: #ec4899"></i> Recent Incidents<br>
            <i style="background: #22c55e"></i> Past Incidents<br>
            <i style="background: #f97316"></i> Satellite Detected Landslides<br>
            <hr style="border: 0; border-top: 1px solid rgba(139, 92, 246, 0.3); margin: 5px 0;">
            <i style="background: rgb(99, 0, 0)"></i> Landslide most likely to occur<br>
            <i style="background: rgb(230, 0, 0)"></i> Landslides have been occurred in the Past<br>
            <i style="background: rgb(254, 172, 0)"></i> Landslide are to be expected<br>
            <i style="background: rgb(254, 244, 141)"></i> Modest level of landslide hazard exist<br>
            <i style="background: rgb(165, 254, 164)"></i> Landslides not likely to occur<br>
            <i style="background: rgb(128, 128, 128)"></i> Not mapped<br>
            <i style="background: rgb(165, 0, 230)"></i> Subsidence & Rockfall<br>
            <i style="background: rgb(115, 223, 255)"></i> Water Bodies<br>
        </div>
    </div>

    <script src="./lib/maplibre-gl.js"></script>
    <script src="./lib/pmtiles.js"></script>

    <script>
        // Global State & Variables
        let searchMarker; // Declared at top to avoid ReferenceErrors
        let controlsPanel;
        let searchResults;
        let searchInput;
        let clearBtn;
        let isDownloading = false;
        let downloadAbortController = null;

        // =============================================
        // OFFLINE STORAGE SYSTEM (IndexedDB)
        // =============================================
        const OFFLINE_DB_NAME = 'offline-maps';
        const OFFLINE_STORE_NAME = 'pmtiles';
        const OFFLINE_FILES = [
            { key: 'hazard_50k', url: 'https://pub-ee4ee353c00e4a7dbe74d0b5339e82b0.r2.dev/LHMP_50000.pmtiles', name: '1:50k Hazard Map' },
            { key: 'satellite_landslides', url: 'satellite_landslides.pmtiles', name: 'Satellite Landslides' }
        ];

        // Open IndexedDB
        function openOfflineDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(OFFLINE_DB_NAME, 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(OFFLINE_STORE_NAME)) {
                        db.createObjectStore(OFFLINE_STORE_NAME);
                    }
                };
            });
        }

        // Save blob to IndexedDB
        async function saveToOfflineDB(key, blob) {
            const db = await openOfflineDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(OFFLINE_STORE_NAME, 'readwrite');
                const store = tx.objectStore(OFFLINE_STORE_NAME);
                const request = store.put(blob, key);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Get blob from IndexedDB
        async function getFromOfflineDB(key) {
            const db = await openOfflineDB();
            return new Promise((resolve, reject) => {
                const tx = db.transaction(OFFLINE_STORE_NAME, 'readonly');
                const store = tx.objectStore(OFFLINE_STORE_NAME);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Check if offline data is available
        async function checkOfflineStatus() {
            try {
                const db = await openOfflineDB();
                const tx = db.transaction(OFFLINE_STORE_NAME, 'readonly');
                const store = tx.objectStore(OFFLINE_STORE_NAME);
                const keys = await new Promise((resolve) => {
                    const req = store.getAllKeys();
                    req.onsuccess = () => resolve(req.result);
                });
                return keys.length >= OFFLINE_FILES.length;
            } catch {
                return false;
            }
        }

        // Update offline button appearance
        async function updateOfflineButtonStatus() {
            const offlineBtn = document.getElementById('offline-btn');
            const isReady = await checkOfflineStatus();

            if (isReady) {
                offlineBtn.innerHTML = '‚úÖ<span class="fab-tooltip">Offline Ready</span>';
                offlineBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            } else {
                offlineBtn.innerHTML = 'üì•<span class="fab-tooltip">Download for Offline</span>';
                offlineBtn.style.background = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
            }
        }

        // Update offline status indicator
        function updateOfflineIndicator() {
            const indicator = document.getElementById('offline-status');
            const text = document.getElementById('offline-status-text');

            if (!navigator.onLine) {
                indicator.style.display = 'block';
                text.textContent = 'üî¥ Offline Mode';
                text.style.color = '#fbbf24';
            } else {
                indicator.style.display = 'none';
            }
        }

        // Listen for online/offline events
        window.addEventListener('online', updateOfflineIndicator);
        window.addEventListener('offline', updateOfflineIndicator);

        // Browser caching and performance optimization
        let protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);

        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap contributors'
                    }
                    // Satellite, hillshade, and hybrid-labels will be loaded on-demand
                },
                layers: [
                    {
                        id: 'osm',
                        type: 'raster',
                        source: 'osm',
                        layout: { visibility: 'visible' }
                    }
                    // Other layers loaded on-demand
                ]
            },
            center: [80.7718, 7.8731],
            zoom: 8,
            maxBounds: [
                [79.5, 5.9], // Southwest coordinates (Sri Lanka bounds)
                [82.0, 9.9] // Northeast coordinates
            ],
            minZoom: 7,
            maxZoom: 18,
            hash: true, // Enable URL hash for sharing map position
            attributionControl: true,
            preserveDrawingBuffer: false, // Better performance
            renderWorldCopies: false, // Don't render map copies
            touchZoomRotate: true,
            touchPitch: true, // Enable pitch for 3D view
            dragRotate: true, // Enable rotation
            pitchWithRotate: true
        });

        // Add Navigation Control (zoom buttons)
        map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'bottom-left');

        // Add Scale Bar (shows distance in km/m)
        map.addControl(new maplibregl.ScaleControl({
            maxWidth: 150,
            unit: 'metric'
        }), 'bottom-right');

        // Progress bar update function
        function updateProgress(percent, status) {
            const progressBar = document.getElementById('progress-bar');
            const loadingStatus = document.getElementById('loading-status');
            if (progressBar) progressBar.style.width = percent + '%';
            if (loadingStatus) loadingStatus.textContent = status;
        }

        // Simulate loading progress
        updateProgress(20, 'Loading base map...');

        const hazardColorMatch = [
            "match",
            ["get", "Hazard"],
            "Landslides not likely to occur", "rgb(165, 254, 164)",
            "Modest level of landslide hazard exist", "rgb(254, 244, 141)",
            "Landslide are to be expected", "rgb(254, 172, 0)",
            "Landslide most likely to occur", "rgb(99, 0, 0)",
            "Water Bodies", "rgb(115, 223, 255)",
            "Landslides have been occurred in the Past", "rgb(230, 0, 0)",
            "Inaccessible slopes", "rgb(128, 128, 128)",
            "Subsidence & Rockfall", "rgb(165, 0, 230)",
            "rgb(52, 52, 52)"
        ];

        map.on('load', () => {
            updateProgress(40, 'Loading hazard layers...');

            // Only load 1:50k initially (lighter, faster)
            map.addSource('hazard_50k', {
                type: 'vector',
                url: 'pmtiles://https://pub-ee4ee353c00e4a7dbe74d0b5339e82b0.r2.dev/LHMP_50000.pmtiles',
                attribution: 'NBRO',
                minzoom: 7,
                maxzoom: 14
            });

            updateProgress(60, 'Loading incident data...');

            // 1:10k loaded on-demand (when zoomed in or toggled)

            map.addSource('early_warning', {
                type: 'geojson',
                data: 'early_warning.geojson',
                tolerance: 10, // Increased tolerance to prevent WebGL "Max vertices" crash
                buffer: 0
            });

            map.addSource('satellite_landslides', {
                type: 'vector',
                url: 'pmtiles://satellite_landslides.pmtiles', // Hosted on GitHub Pages (relative path)
                attribution: 'Human Settlement & Planning Division'
            });

            map.addLayer({
                'id': 'hazard_50k_fill',
                'type': 'fill',
                'source': 'hazard_50k',
                'source-layer': 'hazard_50k',
                'paint': {
                    'fill-color': hazardColorMatch,
                    'fill-opacity': 0.6, // Reduced opacity to let hillshade show through
                    'fill-outline-color': 'rgba(0,0,0,0.1)' // Softer outline
                }
            });

            // 1:10k layer - lazy loaded (saves bandwidth on mobile)
            window.hazard10kLoaded = false;
            window.loadHazard10k = function () {
                if (window.hazard10kLoaded) return;
                window.hazard10kLoaded = true; // Set flag immediately to prevent retries

                if (!map.getSource('hazard_10k')) {
                    map.addSource('hazard_10k', {
                        type: 'vector',
                        url: 'pmtiles://https://pub-ee4ee353c00e4a7dbe74d0b5339e82b0.r2.dev/LHZM_10000.pmtiles',
                        attribution: 'NBRO',
                        minzoom: 12,
                        maxzoom: 18
                    });

                    map.addLayer({
                        'id': 'hazard_10k_fill',
                        'type': 'fill',
                        'source': 'hazard_10k',
                        'source-layer': 'hazard_10k',
                        'paint': {
                            'fill-color': hazardColorMatch,
                            'fill-opacity': 0.6,
                            'fill-outline-color': 'rgba(0,0,0,0.1)'
                        },
                        'layout': {
                            'visibility': document.getElementById('layer-10k').checked ? 'visible' : 'none'
                        }
                    });

                    map.on('click', 'hazard_10k_fill', showPopup);
                    map.on('mouseenter', 'hazard_10k_fill', () => map.getCanvas().style.cursor = 'pointer');
                    map.on('mouseleave', 'hazard_10k_fill', () => map.getCanvas().style.cursor = '');
                }
            }

            // Auto-load 1:10k when zoomed in (zoom level 12+)
            map.on('zoom', () => {
                if (map.getZoom() >= 12 && !window.hazard10kLoaded) {
                    window.loadHazard10k();
                }
            });

            map.addLayer({
                'id': 'early_warning_points',
                'type': 'circle',
                'source': 'early_warning',
                'paint': {
                    'circle-radius': 6,
                    'circle-color': [
                        'match',
                        ['get', 'status'],
                        'recent', '#ec4899', // Pink for recent
                        '#22c55e' // Green for old
                    ],
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                },
                'layout': {
                    'visibility': 'visible'
                }
            });

            // Satellite Landslides (Polygons)
            map.addLayer({
                'id': 'satellite_polygons',
                'type': 'line',
                'source': 'satellite_landslides',
                'source-layer': 'satellite_landslides',
                'filter': ['==', ['get', 'type'], 'landslide_polygon'],
                'paint': {
                    'line-color': '#f97316', // Orange
                    'line-width': 2
                },
                'layout': { 'visibility': 'none' }
            });

            // Satellite Landslides (Points)
            map.addLayer({
                'id': 'satellite_points',
                'type': 'circle',
                'source': 'satellite_landslides',
                'source-layer': 'satellite_landslides',
                'filter': ['==', ['get', 'type'], 'incident_point'],
                'paint': {
                    'circle-radius': 5,
                    'circle-color': '#f97316', // Orange
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#ffffff'
                },
                'layout': { 'visibility': 'none' }
            });

            map.on('click', 'hazard_50k_fill', showPopup);
            map.on('click', 'early_warning_points', showPopup);
            map.on('click', 'satellite_points', showPopup);
            map.on('click', 'satellite_polygons', showPopup);

            map.on('mouseenter', 'hazard_50k_fill', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'hazard_50k_fill', () => map.getCanvas().style.cursor = '');
            map.on('mouseenter', 'early_warning_points', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'early_warning_points', () => map.getCanvas().style.cursor = '');
            map.on('mouseenter', 'satellite_points', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'satellite_points', () => map.getCanvas().style.cursor = '');
            map.on('mouseenter', 'satellite_polygons', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'satellite_polygons', () => map.getCanvas().style.cursor = '');

            // Map loaded - hide loading indicator with smooth transition
            updateProgress(100, 'Map ready!');
            setTimeout(() => {
                document.getElementById('loading-indicator').classList.remove('active');
            }, 500);
        });

        function showPopup(e) {
            const coordinates = e.lngLat;
            const props = e.features[0].properties;

            let content = '<div class="popup-title">Feature Information</div>';
            content += '<div class="popup-info">';
            for (const key in props) {
                if (props[key] !== null) {
                    content += `<b>${key}:</b> ${props[key]}<br>`;
                }
            }
            content += '</div>';

            new maplibregl.Popup()
                .setLngLat(coordinates)
                .setHTML(content)
                .addTo(map);
        }

        document.getElementById('layer-10k').addEventListener('change', (e) => {
            // Load 1:10k on demand if user toggles it
            if (e.target.checked && !window.hazard10kLoaded) {
                window.loadHazard10k();
            }
            if (window.hazard10kLoaded) {
                map.setLayoutProperty('hazard_10k_fill', 'visibility', e.target.checked ? 'visible' : 'none');
            }

            // Dynamic zoom restriction: 1:10k supports up to zoom 18
            updateMaxZoom();
        });

        document.getElementById('opacity-10k').addEventListener('input', (e) => {
            const opacity = parseInt(e.target.value) / 100;
            if (map.getLayer('hazard_10k_fill')) {
                map.setPaintProperty('hazard_10k_fill', 'fill-opacity', opacity);
            }
        });

        document.getElementById('layer-50k').addEventListener('change', (e) => {
            map.setLayoutProperty('hazard_50k_fill', 'visibility', e.target.checked ? 'visible' : 'none');
            // Dynamic zoom restriction: 1:50k supports up to zoom 14
            updateMaxZoom();
        });

        document.getElementById('opacity-50k').addEventListener('input', (e) => {
            const opacity = parseInt(e.target.value) / 100;
            if (map.getLayer('hazard_50k_fill')) {
                map.setPaintProperty('hazard_50k_fill', 'fill-opacity', opacity);
            }
        });

        // Update max zoom based on active layers
        function updateMaxZoom() {
            const is10kActive = document.getElementById('layer-10k').checked;
            const is50kActive = document.getElementById('layer-50k').checked;

            if (is10kActive) {
                // 1:10k layer is on, allow zoom to 18
                map.setMaxZoom(18);
            } else if (is50kActive) {
                // Only 1:50k layer is on, restrict zoom to 14
                map.setMaxZoom(14);
            } else {
                // No hazard layers, default max zoom
                map.setMaxZoom(18);
            }

            // If current zoom exceeds new max, zoom out
            if (map.getZoom() > map.getMaxZoom()) {
                map.setZoom(map.getMaxZoom());
            }
        }

        document.getElementById('layer-warning').addEventListener('change', (e) => {
            map.setLayoutProperty('early_warning_points', 'visibility', e.target.checked ? 'visible' : 'none');
        });

        document.getElementById('layer-satellite-ls').addEventListener('change', (e) => {
            const visibility = e.target.checked ? 'visible' : 'none';
            map.setLayoutProperty('satellite_polygons', 'visibility', visibility);
            map.setLayoutProperty('satellite_points', 'visibility', visibility);
        });



        // Basemap toggle controls with lazy loading
        let satelliteLoaded = false;
        let hillshadeLoaded = false;
        let hybridLabelsLoaded = false;
        let roadsLoaded = false;
        let buildingsLoaded = false;

        function ensureLayersLoaded(layers, callback) {
            let toLoad = [];

            if (layers.includes('satellite') && !satelliteLoaded) {
                toLoad.push({
                    source: 'satellite',
                    config: {
                        type: 'raster',
                        tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
                        tileSize: 256,
                        attribution: 'Tiles &copy; Esri',
                        maxzoom: 17 // Clamp zoom to prevent "Map data not available"
                    },
                    layer: {
                        id: 'satellite',
                        type: 'raster',
                        source: 'satellite',
                        layout: { visibility: 'none' }
                    }
                });
            }

            if (layers.includes('hillshade') && !hillshadeLoaded) {
                // Original Esri Hillshade (user prefers this)
                toLoad.push({
                    source: 'hillshade',
                    config: {
                        type: 'raster',
                        tiles:
                            ['https://server.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}'],
                        tileSize: 256,
                        attribution: 'Tiles &copy; Esri',
                        maxzoom: 14
                    },
                    layer: {
                        id: 'hillshade',
                        type: 'raster',
                        source: 'hillshade',
                        paint: {
                            'raster-opacity': 1.0,
                            'raster-contrast': 0.1
                        },
                        layout: { visibility: 'none' }
                    }
                });
            }

            if (layers.includes('hybrid-labels') && !hybridLabelsLoaded) {
                toLoad.push({
                    source: 'hybrid-labels',
                    config: {
                        type: 'raster',
                        tiles:
                            ['https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}'],
                        tileSize: 256,
                        attribution: 'Tiles &copy; Esri'
                    },
                    layer: {
                        id: 'hybrid-labels',
                        type: 'raster',
                        source: 'hybrid-labels',
                        layout: { visibility: 'none' }
                    }
                });
            }

            if (toLoad.length > 0) {
                toLoad.forEach(item => {
                    if (item.source && !map.getSource(item.source)) {
                        map.addSource(item.source, item.config);
                    }
                    if (item.layer) {
                        // Dynamic layer placement
                        if (item.layer.id === 'hillshade') {
                            map.addLayer(item.layer, 'hazard_50k_fill');
                        } else {
                            map.addLayer(item.layer, 'hazard_50k_fill');
                        }
                    }
                });

                if (layers.includes('satellite')) satelliteLoaded = true;
                if (layers.includes('hillshade')) hillshadeLoaded = true;
                if (layers.includes('hybrid-labels')) hybridLabelsLoaded = true;
            }





            if (callback) callback();
        }

        document.getElementById('basemap-osm').addEventListener('change', (e) => {
            if (e.target.checked) {
                map.setLayoutProperty('osm', 'visibility', 'visible');
                if (satelliteLoaded) map.setLayoutProperty('satellite', 'visibility', 'none');
                if (hybridLabelsLoaded) map.setLayoutProperty('hybrid-labels', 'visibility', 'none');
            }
        });

        document.getElementById('basemap-satellite').addEventListener('change', (e) => {
            if (e.target.checked) {
                ensureLayersLoaded(['satellite'], () => {
                    map.setLayoutProperty('osm', 'visibility', 'none');
                    map.setLayoutProperty('satellite', 'visibility', 'visible');
                    if (hybridLabelsLoaded) map.setLayoutProperty('hybrid-labels', 'visibility', 'none');
                });
            }
        });

        document.getElementById('basemap-hybrid').addEventListener('change', (e) => {
            if (e.target.checked) {
                ensureLayersLoaded(['satellite', 'hybrid-labels'], () => {
                    map.setLayoutProperty('osm', 'visibility', 'none');
                    map.setLayoutProperty('satellite', 'visibility', 'visible');
                    map.setLayoutProperty('hybrid-labels', 'visibility', 'visible');
                });
            }
        });





        document.getElementById('locate-btn').addEventListener('click', () => {
            if (!window.isSecureContext && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                alert("‚ö†Ô∏è Geo-Location requires HTTPS.");
                return;
            }

            if ("geolocation" in navigator) {
                const locateBtn = document.getElementById('locate-btn');
                const loadingIndicator = document.getElementById('loading-indicator');

                loadingIndicator.classList.add('active');
                locateBtn.classList.add('active');
                locateBtn.innerHTML = 'üì°<span class="fab-tooltip">Locating...</span>';

                let watchId = null;
                let startTime = Date.now();
                const TIMEOUT_MS = 15000; // 15 seconds max search time

                // Clear any existing markers
                if (searchMarker) { searchMarker.remove(); searchMarker = null; }
                if (window.gpsMarker) { window.gpsMarker.remove(); }

                function stopLocationWatch() {
                    if (watchId !== null) {
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                    }
                    loadingIndicator.classList.remove('active');
                    locateBtn.classList.remove('active');
                    locateBtn.innerHTML = 'üìç<span class="fab-tooltip">Find Location</span>';
                }

                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;

                        // Create/Update marker
                        if (window.gpsMarker) {
                            window.gpsMarker.setLngLat([lng, lat]);
                            window.gpsMarker.getPopup().setHTML(
                                `<div class="popup-title">üìç Your Location</div>
    <div class="popup-info">
        <b>Latitude:</b> ${lat.toFixed(6)}<br>
        <b>Longitude:</b> ${lng.toFixed(6)}<br>
        <b>Accuracy:</b> ¬±${Math.round(accuracy)}m
    </div>`
                            );
                        } else {
                            window.gpsMarker = new maplibregl.Marker({ color: '#8b5cf6' })
                                .setLngLat([lng, lat])
                                .setPopup(new maplibregl.Popup().setHTML(
                                    `<div class="popup-title">üìç Your Location</div>
    <div class="popup-info">
        <b>Latitude:</b> ${lat.toFixed(6)}<br>
        <b>Longitude:</b> ${lng.toFixed(6)}<br>
        <b>Accuracy:</b> ¬±${Math.round(accuracy)}m
    </div>`
                                ))
                                .addTo(map)
                                .togglePopup();

                            // Fly to location on first fix
                            map.flyTo({ center: [lng, lat], zoom: 16 });
                        }

                        // Check if accuracy is good enough OR timeout reached
                        if (accuracy <= 5 || (Date.now() - startTime) > TIMEOUT_MS) {
                            stopLocationWatch();
                        }
                    },
                    (error) => {
                        console.error("GPS Error:", error);
                        // Only alert on fatal errors, ignore timeout of cached pos
                        if (Date.now() - startTime > TIMEOUT_MS) {
                            stopLocationWatch();
                            alert("‚ö†Ô∏è Location check timed out. Please check GPS reception.");
                        }
                    },
                    { enableHighAccuracy: true, timeout: TIMEOUT_MS, maximumAge: 0 }
                );

                // Safety timeout just in case
                setTimeout(() => {
                    if (watchId !== null) stopLocationWatch();
                }, TIMEOUT_MS + 1000);

            } else {
                alert('Geolocation is not supported by your browser');
            }
        });

        // Search functionality using Nominatim API
        searchInput = document.getElementById('search-input');
        searchResults = document.getElementById('search-results');
        clearBtn = document.getElementById('clear-search');
        let searchTimeout;

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();

            if (query.length > 0) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
                searchResults.style.display = 'none';
                return;
            }

            clearTimeout(searchTimeout);

            // Don't auto-search until user has typed enough (10 chars for GPS coords like "7.123 80.456")
            if (query.length < 10) return;

            // Auto-search after 800ms of no typing (debounce)
            searchTimeout = setTimeout(() => {
                searchLocation(query);
            }, 800);
        });

        // Allow immediate search when pressing Enter
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(searchTimeout); // Cancel any pending auto-search
                const query = searchInput.value.trim();
                if (query.length >= 1) {
                    searchLocation(query);
                }
            }
        });

        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            clearBtn.style.display = 'none';
            searchResults.style.display = 'none';
            if (searchMarker) {
                searchMarker.remove();
            }
        });

        async function searchLocation(query) {
            // Visual feedback
            searchResults.style.display = 'block';
            searchResults.innerHTML = '<div class="no-results" style="color:#8b5cf6;">Searching...</div>';

            // Check if query is GPS coordinates (e.g., "7.456789 80.456789" or "7.456789, 80.456789")
            // Format: Latitude first, Longitude second (like Google Earth)
            const coordPattern = /^(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)$/;
            const match = query.trim().match(coordPattern);

            if (match) {
                // User entered coordinates - parse as LAT, LON (Google Earth order)
                const lat = parseFloat(match[1]);
                const lon = parseFloat(match[2]);

                // Validate coordinates are within Sri Lanka bounds (roughly)
                if (lon >= 79.5 && lon <= 82.0 && lat >= 5.9 && lat <= 9.9) {
                    // Valid Sri Lanka coordinates
                    searchResults.style.display = 'none';

                    map.flyTo({
                        center: [lon, lat],
                        zoom: 14,
                        duration: 1500
                    });

                    if (searchMarker) {
                        searchMarker.remove();
                    }

                    searchMarker = new maplibregl.Marker({ color: '#06b6d4' })
                        .setLngLat([lon, lat])
                        .setPopup(
                            new maplibregl.Popup().setHTML(
                                `<div class="popup-title">GPS Location</div>
                                <div class="popup-info"><b>Latitude:</b> ${lat.toFixed(6)}<br><b>Longitude:</b> ${lon.toFixed(6)}</div>`
                            )
                        )
                        .addTo(map)
                        .togglePopup();

                    // Keep user's format: Lat, Lon
                    searchInput.value = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    return;
                } else {
                    // Coordinates outside Sri Lanka
                    searchResults.innerHTML = '<div class="no-results" style="color:#f59e0b;">‚ö†Ô∏è Coordinates are outside Sri Lanka bounds</div>';
                    return;
                }
            }

            // Otherwise, search by name using Nominatim API
            try {
                // Use browser cache to reduce API calls
                const cacheKey = `geocode_${query}`;
                const cached = sessionStorage.getItem(cacheKey);

                if (cached) {
                    const data = JSON.parse(cached);
                    displayResults(data);
                    return;
                }

                // Add User-Agent header (recommended by Nominatim)
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', Sri Lanka')}&limit=5&countrycodes=lk`,
                    { headers: { 'Accept-Language': 'en' } }
                );

                if (!response.ok) throw new Error("Network response was not ok");

                const data = await response.json();

                // Cache the results
                if (data && data.length > 0) {
                    sessionStorage.setItem(cacheKey, JSON.stringify(data));
                    displayResults(data);
                } else {
                    showNoResults();
                }
            } catch (error) {
                console.error('Search error:', error);
                searchResults.innerHTML = `<div class="no-results" style="color:#ef4444;">Error: ${error.message}. Check network.</div>`;
                searchResults.style.display = 'block';
            }
        }

        function displayResults(results) {
            searchResults.innerHTML = '';
            searchResults.style.display = 'block';

            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';

                const title = document.createElement('div');
                title.className = 'result-title';
                title.textContent = result.display_name.split(',')[0];

                const subtitle = document.createElement('div');
                subtitle.className = 'result-subtitle';
                subtitle.textContent = result.display_name.split(',').slice(1).join(',').trim();

                item.appendChild(title);
                item.appendChild(subtitle);

                item.addEventListener('click', () => {
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);

                    if (isNaN(lat) || isNaN(lon)) {
                        alert("Error: Could not parse location coordinates.");
                        return;
                    }

                    map.flyTo({
                        center: [lon, lat],
                        zoom: 12, // Reduced from 14 to avoid crashing WebGL with heavy 10k tiles
                        duration: 1500
                    });

                    if (searchMarker) {
                        searchMarker.remove();
                    }

                    searchMarker = new maplibregl.Marker({ color: '#06b6d4' })
                        .setLngLat([lon, lat])
                        .setPopup(
                            new maplibregl.Popup().setHTML(
                                `<div class="popup-title">${result.display_name.split(',')[0]}</div>
                    <div class="popup-info">${subtitle.textContent}</div>`
                            )
                        )
                        .addTo(map)
                        .togglePopup();

                    searchResults.style.display = 'none';
                    searchInput.value = result.display_name.split(',')[0];
                });

                searchResults.appendChild(item);
            });
        }

        function showNoResults() {
            searchResults.innerHTML = '<div class="no-results">No results found in Sri Lanka</div>';
            searchResults.style.display = 'block';
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box')) {
                searchResults.style.display = 'none';
            }
        });

        // Legend toggle functionality
        const legendToggle = document.getElementById('legend-toggle');
        const legend = document.querySelector('.legend');

        legendToggle.addEventListener('click', () => {
            legend.classList.toggle('collapsed');

            // Save preference to localStorage
            if (legend.classList.contains('collapsed')) {
                localStorage.setItem('legendCollapsed', 'true');
            } else {
                localStorage.setItem('legendCollapsed', 'false');
            }
        });

        // Restore legend state on page load
        window.addEventListener('load', () => {
            const isLegendCollapsed = localStorage.getItem('legendCollapsed') === 'true';
            if (isLegendCollapsed) {
                legend.classList.add('collapsed');
            }

            const isControlsCollapsed = localStorage.getItem('controlsCollapsed') === 'true';
            if (isControlsCollapsed) {
                controlsPanel.classList.add('collapsed');
            }
        });

        // Controls toggle functionality
        const controlsToggle = document.getElementById('controls-toggle');
        controlsPanel = document.querySelector('.controls-panel');

        controlsToggle.addEventListener('click', () => {
            controlsPanel.classList.toggle('collapsed');

            // Save preference to localStorage
            if (controlsPanel.classList.contains('collapsed')) {
                localStorage.setItem('controlsCollapsed', 'true');
            } else {
                localStorage.setItem('controlsCollapsed', 'false');
            }
        });


        // PWA Installation Logic
        let deferredPrompt;
        const installBtn = document.createElement('button');
        installBtn.className = 'fab-btn';
        installBtn.id = 'install-btn';
        installBtn.style.display = 'none'; // Hidden by default
        installBtn.style.background = 'linear-gradient(135deg, #0f172a, #334155)';
        installBtn.innerHTML = 'üì≤<span class="fab-tooltip">Install App</span>';

        // Append to FAB container
        document.querySelector('.fab-container').appendChild(installBtn);

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later.
            deferredPrompt = e;
            // Update UI to notify the user they can add to home screen
            installBtn.style.display = 'flex';
        });

        installBtn.addEventListener('click', (e) => {
            // Hide our user interface that shows our A2HS button
            installBtn.style.display = 'none';
            // Show the prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the A2HS prompt');
                } else {
                    console.log('User dismissed the A2HS prompt');
                }
                deferredPrompt = null;
            });
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Accordion Functionality
        document.querySelectorAll('.layer-header').forEach(header => {
            header.addEventListener('click', () => {
                const section = header.parentElement;

                // Toggle active class
                section.classList.toggle('active');
            });
        });

        // 3D View Toggle
        let is3DMode = false;
        const view3dBtn = document.getElementById('view3d-btn');

        view3dBtn.addEventListener('click', () => {
            is3DMode = !is3DMode;

            if (is3DMode) {
                // Zoom out first if too zoomed in (prevents WebGL crash)
                const safeZoom = Math.min(map.getZoom(), 14);

                // Switch to 3D view with hillshade
                map.easeTo({
                    pitch: 60,
                    bearing: map.getBearing() || 0,
                    zoom: safeZoom,
                    duration: 1000
                });
                view3dBtn.style.background = 'linear-gradient(135deg, #10b981, #06b6d4)';
                view3dBtn.innerHTML = 'üó∫Ô∏è<span class="fab-tooltip">2D View</span>';

                // Auto-enable hillshade for better 3D effect
                ensureLayersLoaded(['hillshade'], () => {
                    map.setLayoutProperty('hillshade', 'visibility', 'visible');
                });
            } else {
                // Switch to 2D view
                map.easeTo({
                    pitch: 0,
                    bearing: 0,
                    duration: 1000
                });
                view3dBtn.style.background = 'linear-gradient(135deg, #f59e0b, #ef4444)';
                view3dBtn.innerHTML = 'üèîÔ∏è<span class="fab-tooltip">3D Terrain View</span>';

                // Disable hillshade
                if (hillshadeLoaded) {
                    map.setLayoutProperty('hillshade', 'visibility', 'none');
                }
            }
        });

        // Measurement Tool Logic
        let isMeasuring = false;
        let measurePoints = [];
        let measureMarkers = [];
        const measureBtn = document.getElementById('measure-btn');
        const measureResult = document.getElementById('measure-result');
        const distanceValue = document.getElementById('distance-value');
        const clearMeasureBtn = document.getElementById('clear-measure');

        // Haversine formula for distance (km)
        function getDistance(coord1, coord2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(coord2.lat - coord1.lat);
            const dLon = deg2rad(coord2.lng - coord1.lng);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(coord1.lat)) * Math.cos(deg2rad(coord2.lat)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        measureBtn.addEventListener('click', () => {
            isMeasuring = !isMeasuring;
            if (isMeasuring) {
                // measureBtn.textContent = 'üõë Stop Measuring'; // Removed text change, adding active class instead
                measureBtn.classList.add('active');
                measureBtn.innerHTML = 'üõë<span class="fab-tooltip">Stop Measuring</span>';
                measureBtn.style.background = 'linear-gradient(135deg, #ef4444, #f59e0b)';
                map.getCanvas().style.cursor = 'crosshair';
                measureResult.style.display = 'block';
            } else {
                stopMeasuring();
            }
        });

        function stopMeasuring() {
            isMeasuring = false;
            measureBtn.classList.remove('active');
            measureBtn.innerHTML = 'üìè<span class="fab-tooltip">Measure Distance</span>';
            measureBtn.style.background = 'linear-gradient(135deg, #10b981, #0ea5e9)';
            map.getCanvas().style.cursor = '';
        }

        clearMeasureBtn.addEventListener('click', clearMeasurement);

        function clearMeasurement() {
            measurePoints = [];
            measureMarkers.forEach(marker => marker.remove());
            measureMarkers = [];
            distanceValue.textContent = '0.00';
            // Hide the distance result box
            measureResult.style.display = 'none';
            if (map.getSource('measure-line')) {
                map.getSource('measure-line').setData({
                    type: 'Feature',
                    properties: {},
                    geometry: {
                        type: 'LineString',
                        coordinates: []
                    }
                });
            }
            // Also stop measuring mode
            stopMeasuring();
        }

        map.on('click', (e) => {
            if (!isMeasuring) return;

            const point = e.lngLat;
            measurePoints.push(point);

            // Add marker
            const marker = new maplibregl.Marker({ color: '#10b981', scale: 0.8 })
                .setLngLat(point)
                .addTo(map);
            measureMarkers.push(marker);

            // Update line
            const coordinates = measurePoints.map(p => [p.lng, p.lat]);

            if (!map.getSource('measure-line')) {
                map.addSource('measure-line', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                            type: 'LineString',
                            coordinates: coordinates
                        }
                    }
                });
                map.addLayer({
                    id: 'measure-line',
                    type: 'line',
                    source: 'measure-line',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: {
                        'line-color': '#10b981',
                        'line-width': 3,
                        'line-dasharray': [2, 2]
                    }
                });
            } else {
                map.getSource('measure-line').setData({
                    type: 'Feature',
                    properties: {},
                    geometry: {
                        type: 'LineString',
                        coordinates: coordinates
                    }
                });
            }

            // Calculate total distance
            if (measurePoints.length > 1) {
                let totalDist = 0;
                for (let i = 0; i < measurePoints.length - 1; i++) {
                    totalDist += getDistance(measurePoints[i],
                        measurePoints[i + 1]);
                } distanceValue.textContent = totalDist.toFixed(2);
            }
        });

        // =============================================
        // OFFLINE DOWNLOAD FUNCTIONALITY
        // =============================================
        const offlineBtn = document.getElementById('offline-btn');
        const downloadModal = document.getElementById('download-modal');
        const downloadProgress = document.getElementById('download-progress');
        const downloadStatus = document.getElementById('download-status');
        const cancelDownloadBtn = document.getElementById('cancel-download');

        window.addEventListener('load', () => {
            updateOfflineButtonStatus();
            updateOfflineIndicator();
        });

        offlineBtn.addEventListener('click', async () => {
            const isReady = await checkOfflineStatus();
            if (isReady) {
                if (confirm('Offline data is already downloaded. Re-download for latest?')) {
                    await startOfflineDownload();
                }
            } else {
                await startOfflineDownload();
            }
        });

        cancelDownloadBtn.addEventListener('click', () => {
            if (downloadAbortController) {
                downloadAbortController.abort();
                downloadAbortController = null;
            }
            isDownloading = false;
            downloadModal.style.display = 'none';
        });

        async function startOfflineDownload() {
            if (isDownloading) return;
            isDownloading = true;
            downloadAbortController = new AbortController();
            downloadModal.style.display = 'flex';
            downloadProgress.style.width = '0%';
            downloadStatus.textContent = 'Starting download...';
            try {
                let completed = 0;
                const total = OFFLINE_FILES.length;
                for (const file of OFFLINE_FILES) {
                    if (!isDownloading) break;
                    downloadStatus.textContent = 'Downloading ' + file.name + '...';
                    const response = await fetch(file.url, { signal: downloadAbortController.signal });
                    if (!response.ok) throw new Error('Failed to download ' + file.name);
                    const blob = await response.blob();
                    await saveToOfflineDB(file.key, blob);
                    completed++;
                    downloadProgress.style.width = ((completed / total) * 100) + '%';
                }
                downloadStatus.textContent = 'Download complete!';
                downloadProgress.style.width = '100%';
                setTimeout(() => {
                    downloadModal.style.display = 'none';
                    updateOfflineButtonStatus();
                    alert('Maps downloaded! You can use them offline.');
                }, 1000);
            } catch (error) {
                downloadStatus.textContent = error.name === 'AbortError' ? 'Cancelled.' : error.message;
                setTimeout(() => { downloadModal.style.display = 'none'; }, 2000);
            } finally {
                isDownloading = false;
                downloadAbortController = null;
            }
        }

        // =============================================
        // GPS BOOKMARKS FUNCTIONALITY
        // =============================================
        const bookmarkBtn = document.getElementById('bookmark-btn');
        const bookmarksPanel = document.getElementById('bookmarks-panel');
        const bookmarksList = document.getElementById('bookmarks-list');
        const closeBookmarksBtn = document.getElementById('close-bookmarks');
        const saveLocationBtn = document.getElementById('save-current-location');

        function getBookmarks() {
            const stored = localStorage.getItem('mapBookmarks');
            return stored ? JSON.parse(stored) : [];
        }

        function saveBookmarks(bookmarks) {
            localStorage.setItem('mapBookmarks', JSON.stringify(bookmarks));
        }

        function renderBookmarks() {
            const bookmarks = getBookmarks();
            if (bookmarks.length === 0) {
                bookmarksList.innerHTML = '<div style=\"color:#94a3b8; text-align:center; padding:20px; font-size:0.85rem;\">No saved locations yet</div>';
                return;
            }
            bookmarksList.innerHTML = bookmarks.map((b, i) => 
                '<div style=\"display:flex; justify-content:space-between; align-items:center; padding:10px; margin-bottom:6px; background:rgba(139,92,246,0.1); border-radius:8px; cursor:pointer;\">' +
                '<div style=\"flex:1;\" onclick=\"flyToBookmark(' + i + ')\">' +
                '<div style=\"color:#e2e8f0; font-size:0.85rem; font-weight:500;\">‚≠ê ' + b.name + '</div>' +
                '<div style=\"color:#94a3b8; font-size:0.7rem;\">' + b.lat.toFixed(5) + ', ' + b.lon.toFixed(5) + '</div></div>' +
                '<button onclick=\"deleteBookmark(' + i + ')\" style=\"background:none; border:none; color:#ef4444; cursor:pointer; font-size:1rem; padding:4px;\">üóëÔ∏è</button></div>'
            ).join('');
        }

        window.flyToBookmark = function(index) {
            const bookmarks = getBookmarks();
            const b = bookmarks[index];
            if (b) { map.flyTo({ center: [b.lon, b.lat], zoom: 14, duration: 1500 }); bookmarksPanel.style.display = 'none'; }
        };

        window.deleteBookmark = function(index) {
            const bookmarks = getBookmarks();
            bookmarks.splice(index, 1);
            saveBookmarks(bookmarks);
            renderBookmarks();
        };

        bookmarkBtn.addEventListener('click', () => {
            if (bookmarksPanel.style.display === 'none') { renderBookmarks(); bookmarksPanel.style.display = 'block'; }
            else { bookmarksPanel.style.display = 'none'; }
        });

        closeBookmarksBtn.addEventListener('click', () => { bookmarksPanel.style.display = 'none'; });

        saveLocationBtn.addEventListener('click', () => {
            const center = map.getCenter();
            const name = prompt('Enter a name for this location:', 'Location ' + (getBookmarks().length + 1));
            if (name) {
                const bookmarks = getBookmarks();
                bookmarks.push({ name: name, lat: center.lat, lon: center.lng, zoom: map.getZoom(), timestamp: Date.now() });
                saveBookmarks(bookmarks);
                renderBookmarks();
                alert('Location saved!');
            }
        });

        // =============================================
        // COMPASS FUNCTIONALITY  
        // =============================================
        const compassIndicator = document.getElementById('compass-indicator');
        const compassNeedle = document.getElementById('compass-needle');

        map.on('rotate', () => { compassNeedle.style.transform = 'rotate(' + (-map.getBearing()) + 'deg)'; });
        compassIndicator.addEventListener('click', () => { map.easeTo({ bearing: 0, pitch: 0, duration: 500 }); });
        map.on('pitchend', () => { compassIndicator.style.display = map.getPitch() > 0 ? 'block' : 'none'; });
    </script>
</body>

</html>
