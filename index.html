<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Landslide Hazard Zonation Map</title>

    <!-- MapLibre GL JS CSS -->
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">

    <style>
        /* Additional MapLibre-specific styles */
        .maplibregl-ctrl-group {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .maplibregl-ctrl-group button {
            background: transparent;
            color: #cbd5e1;
        }

        .maplibregl-ctrl-group button:hover {
            background: rgba(139, 92, 246, 0.3);
        }

        .maplibregl-popup-content {
            background: rgba(15, 23, 42, 0.97);
            color: #e2e8f0;
            border-radius: 14px;
            border: 1px solid rgba(139, 92, 246, 0.35);
            padding: 1.25rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .maplibregl-popup-tip {
            border-top-color: rgba(15, 23, 42, 0.97);
        }

        .legend {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
        }
    </style>
</head>

<body>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="active">
        <div class="spinner"></div>
        <p>Loading Maps...</p>
        <small>This may take a moment</small>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Control Panel -->
    <div class="controls-panel">
        <h3>Map Controls</h3>

        <div class="layer-section">
            <h4>Hazard Layers</h4>

            <div class="layer-toggle">
                <span class="layer-label">LHZM 1:10,000</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="layer-10k" checked>
                    <span class="slider"></span>
                </label>
            </div>

            <div class="layer-toggle">
                <span class="layer-label">LHZM 1:50,000</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="layer-50k" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <button id="locate-btn" class="action-btn">
            üìç Find My Location
        </button>
    </div>

    <!-- Legend -->
    <div class="legend">
        <h4>Hazard Zones</h4>
        <i style="background: rgb(99, 0, 0)"></i> Landslide most likely to occur<br>
        <i style="background: rgb(230, 0, 0)"></i> Landslides have been occurred in the Past<br>
        <i style="background: rgb(254, 172, 0)"></i> Landslide are to be expected<br>
        <i style="background: rgb(254, 244, 141)"></i> Modest level of landslide hazard exist<br>
        <i style="background: rgb(165, 254, 164)"></i> Landslides not likely to occur<br>
        <i style="background: rgb(128, 128, 128)"></i> Inaccessible slopes<br>
        <i style="background: rgb(165, 0, 230)"></i> Subsidence & Rockfall<br>
        <i style="background: rgb(115, 223, 255)"></i> Water Bodies<br>
    </div>

    <!-- Libraries -->
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/pmtiles@3.0.7/dist/pmtiles.js"></script>

    <script>
        // Initialize PMTiles Protocol
        let protocol = new pmtiles.Protocol();
        maplibregl.addProtocol("pmtiles", protocol.tile);

        // Map Initialization
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap contributors'
                    },
                    'satellite': {
                        type: 'raster',
                        tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
                        tileSize: 256,
                        attribution: 'Tiles &copy; Esri'
                    }
                },
                layers: [
                    {
                        id: 'osm',
                        type: 'raster',
                        source: 'osm',
                        layout: { visibility: 'visible' }
                    },
                    {
                        id: 'satellite',
                        type: 'raster',
                        source: 'satellite',
                        layout: { visibility: 'none' }
                    }
                ]
            },
            center: [80.7718, 7.8731],
            zoom: 8
        });

        // Add Navigation Controls
        map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'bottom-left');

        // Hazard Color Logic (matching original data values)
        const hazardColorMatch = [
            "match",
            ["get", "Hazard"],
            "Landslides not likely to occur", "rgb(165, 254, 164)",
            "Modest level of landslide hazard exist", "rgb(254, 244, 141)",
            "Landslide are to be expected", "rgb(254, 172, 0)",
            "Landslide most likely to occur", "rgb(99, 0, 0)",
            "Water Bodies", "rgb(115, 223, 255)",
            "Landslides have been occurred in the Past", "rgb(230, 0, 0)",
            "Inaccessible slopes", "rgb(128, 128, 128)",
            "Subsidence & Rockfall", "rgb(165, 0, 230)",
            "rgb(52, 52, 52)" // Default
        ];

        map.on('load', () => {
            // Hide loading indicator
            document.getElementById('loading-indicator').classList.remove('active');

            // Add PMTiles Sources from Cloudflare R2
            map.addSource('hazard_50k', {
                type: 'vector',
                url: 'pmtiles://https://pub-ee4ee353c00e4a7dbe74d0b5339e82b0.r2.dev/LHMP_50000.pmtiles',
                attribution: 'NBRO'
            });

            map.addSource('hazard_10k', {
                type: 'vector',
                url: 'pmtiles://https://pub-ee4ee353c00e4a7dbe74d0b5339e82b0.r2.dev/LHZM_10000.pmtiles',
                attribution: 'NBRO'
            });

            // Add Layers
            map.addLayer({
                'id': 'hazard_50k_fill',
                'type': 'fill',
                'source': 'hazard_50k',
                'source-layer': 'hazard_50k',
                'paint': {
                    'fill-color': hazardColorMatch,
                    'fill-opacity': 0.75,
                    'fill-outline-color': '#888'
                }
            });

            map.addLayer({
                'id': 'hazard_10k_fill',
                'type': 'fill',
                'source': 'hazard_10k',
                'source-layer': 'hazard_10k',
                'paint': {
                    'fill-color': hazardColorMatch,
                    'fill-opacity': 0.75,
                    'fill-outline-color': '#888'
                },
                'layout': {
                    'visibility': 'visible'
                }
            });

            // Popup on click
            map.on('click', 'hazard_50k_fill', showPopup);
            map.on('click', 'hazard_10k_fill', showPopup);

            // Change cursor on hover
            map.on('mouseenter', 'hazard_50k_fill', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'hazard_50k_fill', () => map.getCanvas().style.cursor = '');
            map.on('mouseenter', 'hazard_10k_fill', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'hazard_10k_fill', () => map.getCanvas().style.cursor = '');
        });

        function showPopup(e) {
            const coordinates = e.lngLat;
            const props = e.features[0].properties;

            let content = '<div class="popup-title">Feature Information</div>';
            content += '<div class="popup-info">';
            for (const key in props) {
                if (props[key] !== null) {
                    content += `<b>${key}:</b> ${props[key]}<br>`;
                }
            }
            content += '</div>';

            new maplibregl.Popup()
                .setLngLat(coordinates)
                .setHTML(content)
                .addTo(map);
        }

        // Layer Toggle Controls
        document.getElementById('layer-10k').addEventListener('change', (e) => {
            map.setLayoutProperty('hazard_10k_fill', 'visibility', e.target.checked ? 'visible' : 'none');
        });

        document.getElementById('layer-50k').addEventListener('change', (e) => {
            map.setLayoutProperty('hazard_50k_fill', 'visibility', e.target.checked ? 'visible' : 'none');
        });

        // Geolocation
        document.getElementById('locate-btn').addEventListener('click', () => {
            if ("geolocation" in navigator) {
                document.getElementById('loading-indicator').classList.add('active');

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        document.getElementById('loading-indicator').classList.remove('active');
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        map.flyTo({ center: [lng, lat], zoom: 14 });

                        // Add marker
                        new maplibregl.Marker({ color: '#8b5cf6' })
                            .setLngLat([lng, lat])
                            .setPopup(new maplibregl.Popup().setHTML('<b>You are here</b>'))
                            .addTo(map)
                            .togglePopup();
                    },
                    (error) => {
                        document.getElementById('loading-indicator').classList.remove('active');
                        alert('Unable to get your location: ' + error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser');
            }
        });

    </script>
</body>

</html>